{% extends 'registrations/base.html' %}
{% load static %}

{% block title %}Register for ASPIR{% endblock %}

{% block content %}
<div class="export-wrapper" style="font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Inter', 'Helvetica Neue', Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.3.3/build/css/intlTelInput.min.css" />
  
  <!-- Navigation -->
  <nav style="padding: 16px 0; border-bottom: 1px solid #d2d2d7; position: sticky; top: 0; background: rgba(255, 255, 255, 0.8); backdrop-filter: saturate(180%) blur(20px); z-index: 100;">
    <div class="container" style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
      <a href="{% url 'home' %}" style="display: flex; align-items: center; text-decoration: none; transition: transform 0.2s ease; flex-shrink: 0;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
        <img src="{% static 'images/Elevate-Tribe-Bg-Remover.png' %}" alt="ASPIR Logo" style="height: 50px; width: auto;">
      </a>
      <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
        <a href="{% url 'home' %}" class="back-home-btn" style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 12px; background: #0071e3; color: white; text-decoration: none; font-weight: 500; font-size: 14px; box-shadow: 0 4px 12px rgba(0, 113, 227, 0.2); transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); white-space: nowrap; flex-shrink: 0;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(0, 113, 227, 0.3)'; this.style.background='#0077ed'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 113, 227, 0.2)'; this.style.background='#0071e3'">
          <iconify-icon icon="lucide:arrow-left" style="font-size: 16px;"></iconify-icon>
          <span class="back-home-text">Back to Home</span>
        </a>
        <a href="/admin-panel/login/" style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 12px; background: transparent; color: #64748b; text-decoration: none; font-weight: 500; font-size: 14px; border: 1.5px solid #e5e7eb; transition: all 0.3s ease; white-space: nowrap; flex-shrink: 0;" onmouseover="this.style.borderColor='#0071e3'; this.style.color='#0071e3'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.color='#64748b'">
          <iconify-icon icon="lucide:lock" style="font-size: 16px;"></iconify-icon>
          <span>Admin Login</span>
        </a>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <section class="hero-section" style="background: linear-gradient(180deg, #ffffff 0%, #f5f5f7 100%); padding: 60px 0 40px; position: relative; overflow: hidden;">
    <!-- Background decorations -->
    <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 70%); border-radius: 50%; animation: float 15s ease-in-out infinite;"></div>
    <div style="position: absolute; bottom: -30px; left: -30px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(249, 115, 22, 0.08) 0%, transparent 70%); border-radius: 50%; animation: float 20s ease-in-out infinite reverse;"></div>
    
    <div class="container" style="text-align: center; position: relative; z-index: 1;">
      <!-- Progress Indicator -->
      <div style="display: flex; justify-content: center; align-items: center; gap: 12px; margin-bottom: 40px;">
        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: rgba(0, 113, 227, 0.1); border: 1px solid rgba(0, 113, 227, 0.2); border-radius: 50px;">
          <div style="width: 8px; height: 8px; background: #0071e3; border-radius: 50%; animation: pulse 2s infinite;"></div>
          <span style="font-size: 13px; font-weight: 500; color: #0071e3;">Step 1 of 2</span>
        </div>
      </div>
      
      <h1 class="hero-title" style="font-size: 48px; font-weight: 600; margin-bottom: 16px; letter-spacing: -0.03em; color: #1d1d1f; line-height: 1.1;">
        Register for ASPIR
      </h1>
      <p class="hero-subtitle" style="font-size: 18px; color: #86868b; max-width: 680px; margin: 0 auto 16px; line-height: 1.5; font-weight: 400; padding: 0 16px;">
        Complete your registration below. Your information is secure. After submitting, you can pay with Squad or Paystack.
      </p>
      <div style="max-width: 560px; margin: 0 auto 24px; padding: 12px 18px; background: rgba(0, 113, 227, 0.08); border: 1px solid rgba(0, 113, 227, 0.2); border-radius: 12px; font-size: 14px; color: #374151; line-height: 1.5;">
        <strong style="color: #1d1d1f;">All payments are in US Dollars (USD).</strong> Your bank may convert to your local currency. Cards from any country are accepted.
      </div>
      
    </div>
  </section>

  <!-- Registration Form Section -->
  <section class="form-section-wrapper" style="padding: 40px 0; background: linear-gradient(180deg, #ffffff 0%, #f5f5f7 100%);">
    <div class="container">
      <div style="max-width: 1000px; margin: 0 auto;">
        <!-- Registration Form -->
        <div class="registration-form-card" style="background: rgba(255, 255, 255, 0.9); backdrop-filter: saturate(180%) blur(20px); border-radius: 24px; padding: 40px; border: 1px solid #d2d2d7; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); position: relative; overflow: hidden;">
          <!-- Decorative gradient top -->
          <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #0071e3, #ff6b35, #34c759);"></div>
          
          <form id="registration-form" method="post" action="{% url 'initialize_payment' %}">
            {% csrf_token %}
            
            <!-- Student Details -->
            <div class="form-section" style="margin-bottom: 40px;">
              <div class="section-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #d2d2d7;">
                <div class="section-icon" style="width: 44px; height: 44px; background: #0071e3; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 113, 227, 0.2); flex-shrink: 0;">
                  <iconify-icon icon="lucide:user" style="font-size: 22px; color: white;"></iconify-icon>
                </div>
                <div>
                  <h3 class="section-title" style="font-size: 22px; font-weight: 600; margin: 0 0 4px 0; color: #1d1d1f; letter-spacing: -0.01em;">Student Information</h3>
                  <p class="section-subtitle" style="font-size: 13px; color: #86868b; margin: 0; font-weight: 400;">Tell us about yourself</p>
                </div>
              </div>

              <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="form-group-modern">
                  <label style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; color: #1d1d1f;">{{ form.full_name.label }}</label>
                  <div style="position: relative;">
                    {{ form.full_name }}
                    <iconify-icon icon="lucide:user" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; color: #9ca3af;"></iconify-icon>
                  </div>
                  {% if form.full_name.errors %}
                    <div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.full_name.errors }}</div>
                  {% endif %}
                </div>
                <div class="form-group-modern">
                  <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #374151;">{{ form.age.label }}</label>
                  <div style="position: relative;">
                    {{ form.age }}
                    <iconify-icon icon="lucide:calendar" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; color: #9ca3af;"></iconify-icon>
                  </div>
                  {% if form.age.errors %}
                    <div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.age.errors }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="form-group-modern">
                  <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #374151;">{{ form.email.label }}</label>
                  <div style="position: relative;">
                    {{ form.email }}
                    <iconify-icon icon="lucide:mail" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; color: #9ca3af;"></iconify-icon>
                  </div>
                  <a id="email-already-registered-link" href="#" style="display: none; margin-top: 10px; padding: 12px 16px; background: rgba(0, 113, 227, 0.1); border: 1px solid rgba(0, 113, 227, 0.25); border-radius: 12px; font-size: 14px; color: #1d1d1f; text-decoration: none; cursor: pointer; position: relative; z-index: 10;">
                    <iconify-icon icon="lucide:info" style="vertical-align: middle; margin-right: 6px; color: #0071e3;"></iconify-icon>
                    This email is already registered. <span style="color: #0071e3; font-weight: 600;">Complete your payment →</span>
                  </a>
                  {% if form.email.errors %}
                    <div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.email.errors }}</div>
                  {% endif %}
                </div>
                <div class="form-group-modern phone-field-group">
                  <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #374151;">{{ form.phone.label }}</label>
                  <div style="position: relative;">
                    {{ form.phone }}
                  </div>
                  {% if form.phone.errors %}
                    <div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.phone.errors }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="form-group-modern">
                <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #374151;">{{ form.country.label }}</label>
                <div style="position: relative;">
                  {{ form.country }}
                  <iconify-icon icon="lucide:globe" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; color: #9ca3af; pointer-events: none;"></iconify-icon>
                </div>
                {% if form.country.errors %}
                  <div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.country.errors }}</div>
                {% endif %}
              </div>
            </div>

            <!-- Guardian Details (Required for All) -->
            <div class="form-section" id="guardian-section" style="margin-bottom: 40px; padding: 24px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(14, 165, 233, 0.05)); border-radius: 20px; border: 2px solid rgba(16, 185, 129, 0.1);">
              <div class="section-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
                <div class="section-icon" style="width: 44px; height: 44px; background: linear-gradient(135deg, #10B981, #059669); border-radius: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3); flex-shrink: 0;">
                  <iconify-icon icon="lucide:shield" style="font-size: 22px; color: white;"></iconify-icon>
                </div>
                <div>
                  <h3 class="section-title" style="font-size: 22px; font-weight: 700; margin: 0 0 4px 0; color: #1e293b;">Parent / Guardian Details</h3>
                  <p class="section-subtitle" style="font-size: 13px; color: #64748b; margin: 0;">Required for all registrations</p>
                </div>
              </div>

              <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group-modern">
                  <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #374151;">{{ form.guardian_name.label }} <span style="color: #ef4444;">*</span></label>
                  <div style="position: relative;">
                    {{ form.guardian_name }}
                    <iconify-icon icon="lucide:user-check" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; color: #9ca3af;"></iconify-icon>
                  </div>
                  {% if form.guardian_name.errors %}
                    <div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.guardian_name.errors }}</div>
                  {% endif %}
                </div>
                <div class="form-group-modern phone-field-group">
                  <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #374151;">{{ form.guardian_phone.label }} <span style="color: #ef4444;">*</span></label>
                  <div style="position: relative;">
                    {{ form.guardian_phone }}
                  </div>
                  {% if form.guardian_phone.errors %}
                    <div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.guardian_phone.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Program Details -->
            <div class="form-section program-selection-section" style="margin-bottom: 40px;">
              <div class="section-header program-section-header" style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid rgba(249, 115, 22, 0.1);">
                <div class="section-icon" style="width: 44px; height: 44px; background: linear-gradient(135deg, #F97316, #EA580C); border-radius: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(249, 115, 22, 0.3); flex-shrink: 0;">
                  <iconify-icon icon="lucide:book-open" style="font-size: 22px; color: white;"></iconify-icon>
                </div>
                <div style="flex: 1; min-width: 0;">
                  <h3 class="section-title" style="font-size: 22px; font-weight: 700; margin: 0 0 4px 0; color: #1e293b;">Program Selection</h3>
                  <p class="section-subtitle" style="font-size: 13px; color: #64748b; margin: 0 0 16px 0;">Choose your cohort and age group</p>
                  
                  <!-- Clear Instructions Box -->
                  <div class="program-instructions-box" style="margin-top: 16px; padding: 16px; background: linear-gradient(135deg, rgba(0, 113, 227, 0.08), rgba(139, 92, 246, 0.06)); border: 2px solid rgba(0, 113, 227, 0.15); border-radius: 12px; border-left: 4px solid #0071e3;">
                    <div class="instructions-header" style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 16px;">
                      <div class="instructions-icon" style="width: 32px; height: 32px; background: #0071e3; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <iconify-icon icon="lucide:info" style="font-size: 18px; color: white;"></iconify-icon>
                      </div>
                      <div style="flex: 1; min-width: 0;">
                        <div class="instructions-title" style="font-size: 16px; font-weight: 600; color: #1d1d1f; margin-bottom: 16px; text-align: left;">Understanding Your Selection</div>
                        <div class="instructions-content" style="font-size: 14px; color: #374151; line-height: 1.7; text-align: left;">
                          <div style="margin-bottom: 16px;">
                            <strong style="color: #0071e3; display: block; margin-bottom: 8px; font-size: 15px; font-weight: 600;">What is a Cohort?</strong>
                            <p style="color: #64748b; margin: 0; line-height: 1.6; text-align: left;">A cohort is a group of students who start the program together at the same time. Each cohort follows a specific schedule and learning path designed for that group.</p>
                          </div>
                          <div>
                            <strong style="color: #0071e3; display: block; margin-bottom: 8px; font-size: 15px; font-weight: 600;">What is a Learning Path?</strong>
                            <p style="color: #64748b; margin: 0 0 10px 0; line-height: 1.6; text-align: left;">A learning path (also called a "dimension") is the focus area of your program. Examples include:</p>
                            <ul class="learning-path-list" style="margin: 0; padding-left: 24px; color: #64748b; list-style: disc; text-align: left;">
                              <li style="margin-bottom: 8px; line-height: 1.6;"><strong style="color: #374151;">Spiritual Growth (S):</strong> <span style="color: #64748b;">Focus on spiritual development and faith-based learning</span></li>
                              <li style="margin-bottom: 8px; line-height: 1.6;"><strong style="color: #374151;">Academic Excellence (A):</strong> <span style="color: #64748b;">Focus on academic achievement and educational growth</span></li>
                              <li style="margin-bottom: 8px; line-height: 1.6;"><strong style="color: #374151;">Physical Development (P):</strong> <span style="color: #64748b;">Focus on physical health and wellness</span></li>
                              <li style="margin-bottom: 8px; line-height: 1.6;"><strong style="color: #374151;">Interpersonal Skills (I):</strong> <span style="color: #64748b;">Focus on social skills and relationships</span></li>
                              <li style="margin-bottom: 0; line-height: 1.6;"><strong style="color: #374151;">Resilience (R):</strong> <span style="color: #64748b;">Focus on building strength and adaptability</span></li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="automatic-assignment-box" style="margin-top: 16px; padding: 16px 20px; background: rgba(139, 92, 246, 0.06); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 16px;">
                    <div class="assignment-title" style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 10px; text-align: left;">Automatic Assignment</div>
                    <div class="assignment-content" style="font-size: 13px; color: #64748b; line-height: 1.7; text-align: left;">
                      <div style="margin-bottom: 8px; line-height: 1.6;">
                        <strong style="color: #374151;">Cohort 1:</strong> 
                        <span style="color: #64748b;">Spiritual Growth (S) - Returning Learner - $120</span>
                      </div>
                      <div style="line-height: 1.6;">
                        <strong style="color: #374151;">Cohort 2:</strong> 
                        <span style="color: #64748b;">Academic Excellence (A) - New Learner - $150</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                <div class="form-group-modern">
                  <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #374151;">{{ form.cohort.label }}</label>
                  <div style="position: relative;">
                    {{ form.cohort }}
                    <iconify-icon icon="lucide:calendar-days" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; color: #9ca3af; pointer-events: none;"></iconify-icon>
                  </div>
                  {% if form.cohort.errors %}
                    <div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.cohort.errors }}</div>
                  {% endif %}
                </div>
                <div class="form-group-modern">
                  <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #374151;">{{ form.group.label }}</label>
                  <div style="position: relative;">
                    {{ form.group }}
                    <iconify-icon icon="lucide:users" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; color: #9ca3af; pointer-events: none;"></iconify-icon>
                  </div>
                  {% if form.group.errors %}
                    <div style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ form.group.errors }}</div>
                  {% endif %}
                </div>
              </div>

              <!-- Hidden fields for dimension and enrollment_type (auto-assigned based on cohort) -->
              {{ form.dimension }}
              {{ form.enrollment_type }}
              {% if form.dimension.errors %}
                <div style="color: #ef4444; font-size: 12px; margin-top: 8px;">{{ form.dimension.errors }}</div>
              {% endif %}
              {% if form.enrollment_type.errors %}
                <div style="color: #ef4444; font-size: 12px; margin-top: 8px;">{{ form.enrollment_type.errors }}</div>
              {% endif %}

              <div class="form-group-modern">
                <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #374151;">{{ form.referral_source.label }} <span style="color: #9ca3af; font-weight: 400;">(Optional)</span></label>
                <div style="position: relative;">
                  {{ form.referral_source }}
                  <iconify-icon icon="lucide:share" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; color: #9ca3af; pointer-events: none;"></iconify-icon>
                </div>
              </div>
            </div>


            <!-- Honeypot field (hidden) -->
            {{ form.website }}

            <!-- Payment Summary -->
            <div class="payment-summary-section" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(14, 165, 233, 0.05)); border-radius: 20px; padding: 24px; margin: 40px 0; border: 2px solid rgba(139, 92, 246, 0.1); position: relative; overflow: hidden;">
              <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #8B5CF6, #F97316, #0EA5E9);"></div>
              
              <div class="section-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                <div class="section-icon" style="width: 44px; height: 44px; background: linear-gradient(135deg, #0EA5E9, #0284C7); border-radius: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(14, 165, 233, 0.3); flex-shrink: 0;">
                  <iconify-icon icon="lucide:credit-card" style="font-size: 22px; color: white;"></iconify-icon>
                </div>
                <div>
                  <h3 class="section-title" style="font-size: 20px; font-weight: 700; margin: 0 0 4px 0; color: #1e293b;">Payment Summary</h3>
                  <p class="section-subtitle" style="font-size: 13px; color: #64748b; margin: 0;">Choose your payment option</p>
                </div>
              </div>
              
              <!-- Payment Option Toggle -->
              <div class="payment-options" style="background: rgba(139, 92, 246, 0.05); border: 2px solid rgba(139, 92, 246, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                <label style="display: block; font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 4px;">Payment option:</label>
                <p style="font-size: 12px; color: #64748b; margin: 0 0 12px 0;">Choose to pay registration fee only (and course fee later) or the full amount now.</p>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                  <label class="payment-option-label" style="display: flex; align-items: center; gap: 10px; padding: 14px; background: rgba(139, 92, 246, 0.05); border: 2px solid #8b5cf6; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;" id="payment-option-partial-label">
                    <input type="radio" name="payment_option" id="payment-option-partial" value="partial" checked style="width: 18px; height: 18px; accent-color: #8b5cf6; cursor: pointer; flex-shrink: 0;">
                    <div style="flex: 1; min-width: 0;">
                      <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px; font-size: 14px;">Pay Registration Fee Now</div>
                      <div style="font-size: 12px; color: #64748b; line-height: 1.4;">Pay $<span id="partial-reg-fee">{{ pricing_config.registration_fee|floatformat:2 }}</span> (≈ ₦<span id="partial-reg-fee-ngn">{{ current_reg_fee_ngn|floatformat:0 }}</span>) now, pay course fee later</div>
                    </div>
                    <iconify-icon icon="lucide:calendar" style="font-size: 20px; color: #8b5cf6; flex-shrink: 0;"></iconify-icon>
                  </label>
                  
                  <label class="payment-option-label" style="display: flex; align-items: center; gap: 10px; padding: 14px; background: white; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;" id="payment-option-full-label">
                    <input type="radio" name="payment_option" id="payment-option-full" value="full" style="width: 18px; height: 18px; accent-color: #34c759; cursor: pointer; flex-shrink: 0;">
                    <div style="flex: 1; min-width: 0;">
                      <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px; font-size: 14px;">Pay Full Amount Now</div>
                      <div style="font-size: 12px; color: #64748b; line-height: 1.4;">Pay $<span id="full-total-fee">{{ pricing_config.total_amount|floatformat:2 }}</span> (≈ ₦<span id="full-total-fee-ngn">{{ current_total_ngn|floatformat:0 }}</span>) now and complete enrollment</div>
                    </div>
                    <iconify-icon icon="lucide:check-circle-2" style="font-size: 20px; color: #34c759; flex-shrink: 0;"></iconify-icon>
                  </label>
                </div>
              </div>
              
              <!-- Payment Platform Choice -->
              <div class="payment-platform-options" style="background: rgba(0, 113, 227, 0.05); border: 2px solid rgba(0, 113, 227, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                <label style="display: block; font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 12px;">Payment platform:</label>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                  <label class="gateway-option-label" style="display: flex; align-items: center; gap: 10px; padding: 14px; background: white; border: 2px solid #0071e3; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;" id="gateway-squad-label">
                    <input type="radio" name="payment_gateway" id="gateway-squad" value="squad" checked style="width: 18px; height: 18px; accent-color: #0071e3; cursor: pointer; flex-shrink: 0;">
                    <div style="flex: 1; min-width: 0;">
                      <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px; font-size: 14px;">Squad</div>
                      <div style="font-size: 12px; color: #64748b; line-height: 1.4;">Card, Bank, USSD, Transfer</div>
                    </div>
                    <iconify-icon icon="lucide:credit-card" style="font-size: 20px; color: #0071e3; flex-shrink: 0;"></iconify-icon>
                  </label>
                  <label class="gateway-option-label" style="display: flex; align-items: center; gap: 10px; padding: 14px; background: white; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;" id="gateway-paystack-label">
                    <input type="radio" name="payment_gateway" id="gateway-paystack" value="paystack" style="width: 18px; height: 18px; accent-color: #00c3f7; cursor: pointer; flex-shrink: 0;">
                    <div style="flex: 1; min-width: 0;">
                      <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px; font-size: 14px;">Paystack</div>
                      <div style="font-size: 12px; color: #64748b; line-height: 1.4;">Card, Bank, USSD, Transfer (alternative)</div>
                    </div>
                    <iconify-icon icon="lucide:wallet" style="font-size: 20px; color: #00c3f7; flex-shrink: 0;"></iconify-icon>
                  </label>
                </div>
                <p style="font-size: 13px; color: #64748b; margin: 12px 0 0 0; padding: 10px 12px; background: rgba(0, 113, 227, 0.06); border-radius: 8px; line-height: 1.5;">
                  <strong style="color: #1d1d1f;">Paying from outside Nigeria?</strong> Use a card that allows international transactions. If your card is declined, try another card or <a href="mailto:info@elevatetribeanalytics.com" style="color: #0071e3;">contact us</a> for help.
                </p>
              </div>
              
              <!-- Dynamic Payment Display -->
              <div id="payment-amount-display" class="payment-amount-display" style="background: rgba(255, 107, 53, 0.08); border: 1px solid rgba(255, 107, 53, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                  <span style="font-size: 15px; font-weight: 600; color: #1e293b;">Amount Due Now:</span>
                  <div style="text-align: right;">
                    <div id="total-amount" style="font-size: 32px; font-weight: 800; color: #ff6b35; line-height: 1.2;">
                      $<span id="amount-display">{{ pricing_config.registration_fee|floatformat:2 }}</span>
                    </div>
                    <div id="ngn-amount-display" style="font-size: 13px; color: #64748b; margin-top: 4px; font-weight: 500;">
                      ≈ ₦<span id="ngn-amount">{{ current_reg_fee_ngn|floatformat:0 }}</span>
                    </div>
                  </div>
                </div>
                <div style="background: rgba(0, 113, 227, 0.08); border: 1px solid rgba(0, 113, 227, 0.15); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                    <iconify-icon icon="lucide:globe" style="font-size: 16px; color: #0071e3;"></iconify-icon>
                    <span style="font-size: 13px; font-weight: 600; color: #1d1d1f;">Payment Currency:</span>
                  </div>
                  <p style="font-size: 12px; color: #64748b; margin: 0; line-height: 1.5;">
                    Payment will be processed in <strong style="color: #0071e3;">Nigerian Naira (₦)</strong>. The amount shown above is converted using today's exchange rate (1 USD = ₦<span id="exchange-rate-display">{{ exchange_rate|floatformat:2 }}</span>). Your bank or payment provider will convert from your local currency automatically at the time of payment. The final amount may vary slightly based on your bank's conversion rate.
                  </p>
                </div>
                <p id="payment-info-text" style="font-size: 13px; color: #64748b; margin: 0; line-height: 1.5;">
                  <iconify-icon icon="lucide:info" style="font-size: 14px; vertical-align: middle;"></iconify-icon>
                  You'll pay the course fee later to complete your enrollment.
                </p>
              </div>
              
              {% if pricing_config %}
              <div style="background: rgba(139, 92, 246, 0.05); border-radius: 12px; padding: 16px;">
                <div style="display: flex; justify-content: space-between; font-size: 14px; color: #64748b; margin-bottom: 8px;">
                  <span>Registration Fee:</span>
                  <div style="text-align: right;">
                    <strong id="registration-fee-amount" style="color: #ff6b35;">${{ pricing_config.registration_fee|floatformat:2 }}</strong>
                    <div style="font-size: 12px; color: #86868b;">≈ ₦<span id="registration-fee-ngn">{{ current_reg_fee_ngn|floatformat:0 }}</span></div>
                  </div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 14px; color: #64748b; margin-bottom: 8px;">
                  <span>Course Fee:</span>
                  <div style="text-align: right;">
                    <strong id="course-fee-amount" style="color: #64748b;">${{ pricing_config.course_fee|floatformat:2 }}</strong>
                    <div style="font-size: 12px; color: #86868b;">≈ ₦<span id="course-fee-ngn">{{ current_course_fee_ngn|floatformat:0 }}</span></div>
                  </div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 16px; font-weight: 600; color: #1e293b; padding-top: 12px; border-top: 1px solid rgba(139, 92, 246, 0.1); margin-top: 8px;">
                  <span>Total Program Fee:</span>
                  <div style="text-align: right;">
                    <strong>${{ pricing_config.total_amount|floatformat:2 }}</strong>
                    <div style="font-size: 13px; color: #86868b; font-weight: 500;">≈ ₦<span id="total-fee-ngn">{{ current_total_ngn|floatformat:0 }}</span></div>
                  </div>
                </div>
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(139, 92, 246, 0.1);">
                  <div style="display: flex; align-items: flex-start; gap: 8px;">
                    <iconify-icon icon="lucide:info" style="font-size: 14px; color: #0071e3; flex-shrink: 0; margin-top: 2px;"></iconify-icon>
                    <div>
                      <p style="font-size: 11px; color: #86868b; margin: 0 0 4px 0; line-height: 1.4;">
                        <strong style="color: #1d1d1f;">Exchange Rate:</strong> 1 USD = ₦<span id="exchange-rate-breakdown">{{ exchange_rate|floatformat:2 }}</span> (updated daily)
                      </p>
                      <p style="font-size: 11px; color: #86868b; margin: 0; line-height: 1.4;">
                        <strong style="color: #1d1d1f;">Note:</strong> The NGN amounts shown are estimates. Your bank will use their own exchange rate at the time of payment, which may result in a slightly different amount in your local currency.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>

            <div style="text-align: center;">
              <button type="submit" class="submit-btn-modern" id="submit-btn" style="width: 100%; max-width: 400px; height: 64px; background: linear-gradient(135deg, #8B5CF6, #F97316); color: white; border: none; border-radius: 20px; font-size: 18px; font-weight: 700; cursor: pointer; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 12px 32px rgba(139, 92, 246, 0.3); position: relative; overflow: hidden; margin-bottom: 20px;">
                <span class="btn-text" style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                  <iconify-icon icon="lucide:arrow-right" style="font-size: 20px;"></iconify-icon>
                  Proceed to Squad Payment
                </span>
                <span class="btn-loader" style="display: none; align-items: center; justify-content: center; gap: 8px;">
                  <iconify-icon icon="lucide:loader-2" style="animation: spin 1s linear infinite; font-size: 20px;"></iconify-icon>
                  Processing...
                </span>
              </button>
              
              <div style="display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; color: #64748b;">
                <div style="width: 20px; height: 20px; background: #10B981; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                  <iconify-icon icon="lucide:lock" style="font-size: 12px; color: white;"></iconify-icon>
                </div>
                <span>Secured by Squad</span>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer-section" style="background: linear-gradient(135deg, #1d1d1f 0%, #1e1b4b 50%, #374151 100%); color: white; padding: 40px 0 24px; position: relative; overflow: hidden;">
    <div style="position: absolute; top: 0; right: 0; width: 150px; height: 150px; background: radial-gradient(circle, rgba(249, 115, 22, 0.08) 0%, transparent 70%); border-radius: 50%;"></div>
    <div class="container text-center">
      <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
        <img src="{% static 'images/Elevate-Tribe-Bg-Remover.png' %}" alt="ASPIR Logo" class="footer-logo" style="height: 60px; width: auto; filter: brightness(0) invert(1);" />
      </div>

      <div class="footer-links" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 16px 24px; margin-bottom: 20px; font-size: 13px;">
        <a href="https://elevatetribeanalytics.com/" style="color: #ff6b35; text-decoration: none; opacity: 0.9; transition: opacity 0.2s;">elevatetribeanalytics.com</a>
        <span style="opacity: 0.5;">•</span>
        <a href="mailto:info@elevatetribeanalytics.com" style="color: #ff6b35; text-decoration: none; opacity: 0.9; transition: opacity 0.2s;">info@elevatetribeanalytics.com</a>
        <span style="opacity: 0.5;">•</span>
        <a href="tel:+233209569399" style="color: #ff6b35; text-decoration: none; opacity: 0.9; transition: opacity 0.2s;">(+233) 20 956 9399</a>
      </div>

      <div class="footer-social" style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
        <a href="#" style="color: white; text-decoration: none; opacity: 0.7; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.opacity='1'; this.style.transform='translateY(-2px)'" onmouseout="this.style.opacity='0.7'; this.style.transform='translateY(0)'">
          <iconify-icon icon="lucide:instagram" style="font-size: 18px;"></iconify-icon>
          <span style="font-size: 13px;">Instagram</span>
        </a>
        <a href="#" style="color: white; text-decoration: none; opacity: 0.7; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.opacity='1'; this.style.transform='translateY(-2px)'" onmouseout="this.style.opacity='0.7'; this.style.transform='translateY(0)'">
          <iconify-icon icon="lucide:linkedin" style="font-size: 18px;"></iconify-icon>
          <span style="font-size: 13px;">LinkedIn</span>
        </a>
        <a href="#" style="color: white; text-decoration: none; opacity: 0.7; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.opacity='1'; this.style.transform='translateY(-2px)'" onmouseout="this.style.opacity='0.7'; this.style.transform='translateY(0)'">
          <iconify-icon icon="lucide:facebook" style="font-size: 18px;"></iconify-icon>
          <span style="font-size: 13px;">Facebook</span>
        </a>
      </div>

      <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 16px;">
        <p style="opacity: 0.5; font-size: 12px; margin: 0;">
          © {% now "Y" %} Elevate Tribe Analytics. All rights reserved.
        </p>
      </div>
    </div>
  </footer>
</div>

<script src="https://code.iconify.design/iconify-icon/3.0.0/iconify-icon.min.js"></script>

<style>
  * {
    box-sizing: border-box;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 24px;
  }

  /* Floating Animation */
  @keyframes float {
    0%, 100% { transform: translate(0, 0) rotate(0deg); }
    33% { transform: translate(20px, -15px) rotate(60deg); }
    66% { transform: translate(-15px, 10px) rotate(120deg); }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.1); }
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Form Styling */
  .form-group-modern input,
  .form-group-modern select,
  .form-group-modern textarea {
    width: 100%;
    height: 54px;
    padding: 0 16px 0 44px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 16px;
    color: #374151;
    background: white;
    transition: all 0.3s ease;
    font-family: 'Montserrat', sans-serif;
  }
  .form-group-modern label {
    font-size: 15px !important;
  }
  
  /* Ensure form groups have proper spacing */
  .form-group-modern {
    margin-bottom: 0;
  }

  /* Intl Tel Input */
  .iti {
    width: 100% !important;
    display: block !important;
  }
  
  .phone-field-group .iti {
    margin-bottom: 0;
  }

  .iti__flag-container {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    z-index: 2;
  }
  
  .iti__selected-flag {
    padding: 0 8px 0 12px !important;
    height: 100%;
    display: flex;
    align-items: center;
    background: #f9fafb;
    border-right: 1px solid #e5e7eb;
    border-radius: 12px 0 0 12px;
  }
  
  .iti__selected-dial-code {
    font-size: 16px;
    color: #374151;
    font-weight: 500;
    margin-right: 4px;
  }
  
  .iti__arrow {
    margin-left: 4px;
    border-top-color: #6b7280;
  }

  .iti--allow-dropdown input,
  .iti--show-selected-dial-code input {
    padding-left: 90px !important;
    padding-right: 16px !important;
    width: 100% !important;
    box-sizing: border-box !important;
  }
  
  .iti input {
    height: 54px !important;
    border: 2px solid #e5e7eb !important;
    border-radius: 12px !important;
    font-size: 16px !important;
    color: #374151 !important;
    background: white !important;
  }
  
  .iti input:focus {
    border-color: #8B5CF6 !important;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1) !important;
    outline: none !important;
  }

  .iti__country-list {
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
    font-family: 'Montserrat', sans-serif;
    font-size: 14px;
    z-index: 1000;
    max-height: 200px;
    overflow-y: auto;
  }
  
  .iti__country {
    padding: 8px 12px;
  }
  
  .iti__country:hover {
    background: #f3f4f6;
  }

  .form-group-modern input:focus,
  .form-group-modern select:focus,
  .form-group-modern textarea:focus {
    outline: none;
    border-color: #8B5CF6;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
  }

  .form-group-modern select {
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px;
  }

  /* Selection Cards */
  .select-card {
    position: relative;
    cursor: pointer;
    display: block;
  }

  .select-card input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .select-card-body {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 20px;
    border: 2px solid #e5e7eb;
    border-radius: 16px;
    background: white;
    transition: all 0.3s ease;
    min-height: 96px;
  }

  .select-card-title {
    font-size: 16px;
    font-weight: 700;
    color: #374151;
    line-height: 1.3;
  }

  .select-card-subtitle {
    font-size: 14px;
    color: #64748b;
  }

  .select-card input:focus-visible + .select-card-body {
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
  }

  .dimension-card .select-card-body {
    align-items: center;
    text-align: center;
  }

  .dimension-card .select-card-badge {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #8B5CF6, #F97316);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 800;
    color: white;
  }

  .dimension-card:hover .select-card-body {
    border-color: #8B5CF6;
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(139, 92, 246, 0.2);
  }

  .dimension-card input:checked + .select-card-body {
    border-color: #8B5CF6;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(249, 115, 22, 0.05));
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(139, 92, 246, 0.3);
  }

  .enrollment-card:hover .select-card-body {
    border-color: #F97316;
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(249, 115, 22, 0.2);
  }

  .enrollment-card input:checked + .select-card-body {
    border-color: #F97316;
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(14, 165, 233, 0.05));
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(249, 115, 22, 0.3);
  }

  /* Submit Button */
  .submit-btn-modern:hover {
    transform: translateY(-3px) scale(1.02) !important;
    box-shadow: 0 16px 40px rgba(139, 92, 246, 0.4) !important;
  }

  .submit-btn-modern:active {
    transform: translateY(-1px) scale(0.98) !important;
  }

  .submit-btn-modern::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s ease;
  }

  .submit-btn-modern:hover::before {
    left: 100%;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .container {
      padding: 0 16px !important;
    }

    /* Navigation Mobile */
    nav {
      padding: 12px 0 !important;
    }
    
    nav .container {
      flex-wrap: wrap;
    }
    
    nav img {
      height: 44px !important;
    }
    
    .back-home-btn {
      padding: 8px 12px !important;
      font-size: 13px !important;
    }
    
    .back-home-text {
      display: none;
    }

    /* Hero Section Mobile */
    .hero-section {
      padding: 40px 0 30px !important;
    }
    
    .hero-title {
      font-size: 32px !important;
      margin-bottom: 12px !important;
      padding: 0 8px !important;
    }
    
    .hero-subtitle {
      font-size: 15px !important;
      margin-bottom: 20px !important;
    }

    /* Form Section Mobile */
    .form-section-wrapper {
      padding: 24px 0 !important;
    }
    
    .registration-form-card {
      padding: 24px 16px !important;
      border-radius: 20px !important;
    }

    /* Section Headers Mobile */
    .section-header {
      flex-wrap: wrap;
      gap: 10px !important;
      margin-bottom: 20px !important;
    }
    
    .program-section-header {
      flex-direction: column !important;
      align-items: flex-start !important;
      gap: 12px !important;
    }
    
    .section-icon {
      width: 40px !important;
      height: 40px !important;
    }
    
    .section-title {
      font-size: 20px !important;
    }
    
    .section-subtitle {
      font-size: 12px !important;
      margin-bottom: 12px !important;
    }

    /* Form Grids Mobile */
    .form-grid {
      grid-template-columns: 1fr !important;
      gap: 16px !important;
      margin-bottom: 16px !important;
    }

    /* Instructions Box Mobile */
    .program-instructions-box {
      padding: 14px 12px !important;
      margin-top: 12px !important;
      border-radius: 10px !important;
    }
    
    .instructions-header {
      flex-direction: column !important;
      gap: 10px !important;
      margin-bottom: 12px !important;
    }
    
    .instructions-icon {
      width: 28px !important;
      height: 28px !important;
    }
    
    .instructions-icon iconify-icon {
      font-size: 16px !important;
    }
    
    .instructions-title {
      font-size: 15px !important;
      margin-bottom: 12px !important;
      text-align: left !important;
    }
    
    .instructions-content {
      font-size: 13px !important;
      line-height: 1.6 !important;
      text-align: left !important;
    }
    
    .instructions-content strong {
      font-size: 14px !important;
      margin-bottom: 8px !important;
    }
    
    .instructions-content p {
      font-size: 13px !important;
      line-height: 1.6 !important;
      text-align: left !important;
      margin-bottom: 0 !important;
    }
    
    .learning-path-list {
      padding-left: 20px !important;
      margin-top: 8px !important;
      font-size: 12px !important;
      line-height: 1.6 !important;
      text-align: left !important;
    }
    
    .learning-path-list li {
      margin-bottom: 8px !important;
      line-height: 1.6 !important;
      text-align: left !important;
    }
    
    .learning-path-list strong {
      font-size: 12px !important;
      color: #374151 !important;
    }
    
    .learning-path-list span {
      color: #64748b !important;
    }
    
    /* Automatic Assignment Box Mobile */
    .automatic-assignment-box {
      padding: 14px 16px !important;
      margin-top: 12px !important;
      border-radius: 12px !important;
    }
    
    .assignment-title {
      font-size: 13px !important;
      margin-bottom: 10px !important;
      text-align: left !important;
    }
    
    .assignment-content {
      font-size: 12px !important;
      line-height: 1.6 !important;
      text-align: left !important;
    }
    
    .assignment-content div {
      margin-bottom: 8px !important;
      line-height: 1.6 !important;
      text-align: left !important;
    }
    
    .assignment-content strong {
      font-size: 12px !important;
      color: #374151 !important;
    }
    
    .assignment-content span {
      color: #64748b !important;
    }

    /* Guardian Section Mobile */
    #guardian-section {
      padding: 20px 16px !important;
      margin-bottom: 32px !important;
    }

    /* Payment Summary Mobile */
    .payment-summary-section {
      padding: 20px 16px !important;
      margin: 32px 0 !important;
    }
    
    .payment-options {
      padding: 14px !important;
    }
    
    .payment-option-label {
      padding: 12px !important;
      gap: 8px !important;
    }
    
    .payment-option-label > div {
      font-size: 13px !important;
    }
    
    .payment-amount-display {
      padding: 14px !important;
    }
    
    #total-amount {
      font-size: 28px !important;
    }
    
    #ngn-amount-display {
      font-size: 12px !important;
    }
    
    /* Pricing Breakdown Mobile */
    .pricing-breakdown {
      padding: 14px !important;
    }
    
    .pricing-row,
    .pricing-row-total {
      font-size: 13px !important;
      flex-wrap: wrap;
    }
    
    .pricing-row-total {
      font-size: 15px !important;
    }
    
    .pricing-info {
      margin-top: 10px !important;
      padding-top: 10px !important;
    }
    
    .pricing-info p {
      font-size: 10px !important;
    }

    /* Submit Button Mobile */
    .submit-btn-modern {
      height: 56px !important;
      font-size: 16px !important;
      width: 100% !important;
      max-width: 100% !important;
      border-radius: 16px !important;
      margin-bottom: 16px !important;
    }
    
    /* Form sections mobile */
    .form-section {
      margin-bottom: 32px !important;
    }
    
    /* Footer Mobile */
    .footer-section {
      padding: 32px 0 20px !important;
    }
    
    .footer-logo {
      height: 50px !important;
    }
    
    .footer-links {
      font-size: 12px !important;
      gap: 12px 16px !important;
      flex-direction: row !important;
    }
    
    .footer-links a {
      font-size: 12px !important;
    }
    
    .footer-social {
      gap: 16px !important;
      flex-wrap: wrap !important;
    }
    
    .footer-social a {
      font-size: 12px !important;
    }
  }
  
  /* Very small mobile */
  @media (max-width: 480px) {
    .container {
      padding: 0 12px !important;
    }
    
    /* Navigation Very Small */
    nav {
      padding: 10px 0 !important;
    }
    
    nav img {
      height: 40px !important;
    }
    
    .back-home-btn {
      padding: 6px 10px !important;
      font-size: 12px !important;
    }

    /* Hero Very Small */
    .hero-section {
      padding: 30px 0 24px !important;
    }
    
    .hero-title {
      font-size: 26px !important;
      line-height: 1.2 !important;
    }
    
    .hero-subtitle {
      font-size: 14px !important;
    }

    /* Form Card Very Small */
    .registration-form-card {
      padding: 20px 12px !important;
      border-radius: 16px !important;
    }
    
    .program-section-header {
      gap: 10px !important;
      padding-bottom: 12px !important;
    }
    
    .section-icon {
      width: 36px !important;
      height: 36px !important;
    }
    
    .section-icon iconify-icon {
      font-size: 18px !important;
    }
    
    .section-title {
      font-size: 18px !important;
    }
    
    .section-subtitle {
      font-size: 11px !important;
      margin-bottom: 10px !important;
    }

    /* Phone Input Mobile Fixes - Tablet */
    .phone-field-group .iti {
      width: 100% !important;
    }
    
    .phone-field-group .iti input {
      padding-left: 85px !important;
      padding-right: 14px !important;
      height: 54px !important;
      font-size: 16px !important;
    }
    
    .phone-field-group .iti__selected-flag {
      padding: 0 7px 0 11px !important;
    }
    
    .phone-field-group .iti__selected-dial-code {
      font-size: 15px !important;
    }
    
    /* Form Groups Very Small */
    .form-group-modern input,
    .form-group-modern select,
    .form-group-modern textarea {
      height: 48px !important;
      padding: 0 12px 0 40px !important;
      font-size: 15px !important;
    }
    
    /* Phone Input Mobile Fixes - Small Mobile */
    .phone-field-group .iti input {
      padding-left: 75px !important;
      padding-right: 12px !important;
      height: 48px !important;
      font-size: 15px !important;
    }
    
    .phone-field-group .iti__selected-flag {
      padding: 0 5px 0 9px !important;
      min-width: auto !important;
    }
    
    .phone-field-group .iti__selected-dial-code {
      font-size: 14px !important;
      margin-right: 2px !important;
    }
    
    .phone-field-group .iti__arrow {
      margin-left: 2px !important;
      width: 8px !important;
      height: 8px !important;
    }
    
    .form-group-modern label {
      font-size: 13px !important;
      margin-bottom: 6px !important;
    }

    /* Payment Summary Very Small */
    .payment-summary-section {
      padding: 16px 12px !important;
    }
    
    .payment-options {
      padding: 12px !important;
    }
    
    .payment-option-label {
      padding: 10px !important;
      flex-wrap: wrap;
    }
    
    .payment-option-label > div > div:first-child {
      font-size: 13px !important;
    }
    
    .payment-option-label > div > div:last-child {
      font-size: 11px !important;
    }
    
    #total-amount {
      font-size: 24px !important;
    }
    
    #ngn-amount-display {
      font-size: 11px !important;
    }
    
    /* Pricing Breakdown Very Small */
    .pricing-breakdown {
      padding: 12px !important;
    }
    
    .pricing-row {
      font-size: 12px !important;
      margin-bottom: 6px !important;
    }
    
    .pricing-row-total {
      font-size: 14px !important;
      padding-top: 10px !important;
    }
    
    .pricing-info {
      margin-top: 8px !important;
      padding-top: 8px !important;
    }
    
    .pricing-info p {
      font-size: 9px !important;
      line-height: 1.3 !important;
    }

    /* Submit Button Very Small */
    .submit-btn-modern {
      height: 52px !important;
      font-size: 15px !important;
      padding: 0 16px !important;
    }
    
    /* Instructions Box Very Small */
    .program-instructions-box {
      padding: 12px 10px !important;
      margin-top: 10px !important;
      border-radius: 8px !important;
    }
    
    .instructions-header {
      gap: 8px !important;
      margin-bottom: 10px !important;
    }
    
    .instructions-icon {
      width: 24px !important;
      height: 24px !important;
    }
    
    .instructions-icon iconify-icon {
      font-size: 14px !important;
    }
    
    .instructions-title {
      font-size: 14px !important;
      margin-bottom: 10px !important;
      text-align: left !important;
    }
    
    .instructions-content {
      font-size: 12px !important;
      line-height: 1.6 !important;
      text-align: left !important;
    }
    
    .instructions-content strong {
      font-size: 13px !important;
      margin-bottom: 6px !important;
    }
    
    .instructions-content p {
      font-size: 12px !important;
      line-height: 1.5 !important;
      text-align: left !important;
    }
    
    .learning-path-list {
      padding-left: 18px !important;
      margin-top: 6px !important;
      font-size: 11px !important;
      line-height: 1.5 !important;
      text-align: left !important;
    }
    
    .learning-path-list li {
      margin-bottom: 6px !important;
      line-height: 1.5 !important;
      text-align: left !important;
    }
    
    .learning-path-list strong {
      font-size: 11px !important;
      color: #374151 !important;
    }
    
    .learning-path-list span {
      font-size: 11px !important;
      color: #64748b !important;
    }
    
    /* Automatic Assignment Box Very Small */
    .automatic-assignment-box {
      padding: 12px 14px !important;
      margin-top: 10px !important;
      border-radius: 10px !important;
    }
    
    .assignment-title {
      font-size: 12px !important;
      margin-bottom: 8px !important;
      text-align: left !important;
    }
    
    .assignment-content {
      font-size: 11px !important;
      line-height: 1.5 !important;
      text-align: left !important;
    }
    
    .assignment-content div {
      margin-bottom: 6px !important;
      line-height: 1.5 !important;
      text-align: left !important;
    }
    
    .assignment-content strong {
      font-size: 11px !important;
      color: #374151 !important;
    }
    
    .assignment-content span {
      font-size: 11px !important;
      color: #64748b !important;
    }
    
    /* Phone Input Very Small Mobile */
    .phone-field-group .iti input {
      padding-left: 70px !important;
      padding-right: 10px !important;
      height: 46px !important;
      font-size: 14px !important;
    }
    
    .phone-field-group .iti__selected-flag {
      padding: 0 4px 0 8px !important;
    }
    
    .phone-field-group .iti__selected-dial-code {
      font-size: 13px !important;
      margin-right: 1px !important;
    }
    
    .phone-field-group .iti__arrow {
      margin-left: 1px !important;
      width: 7px !important;
      height: 7px !important;
    }
    
    /* Footer Very Small */
    .footer-section {
      padding: 28px 0 18px !important;
    }
    
    .footer-logo {
      height: 45px !important;
    }
    
    .footer-links {
      font-size: 11px !important;
      gap: 8px 12px !important;
      flex-direction: column !important;
    }
    
    .footer-links a {
      font-size: 11px !important;
      margin-bottom: 4px !important;
    }
    
    .footer-links span {
      display: none !important;
    }
    
    .footer-social {
      gap: 14px !important;
      flex-wrap: wrap !important;
    }
    
    .footer-social a {
      font-size: 11px !important;
    }
    
    .footer-social a span {
      font-size: 11px !important;
    }
  }
</style>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.3.3/build/js/intlTelInput.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('registration-form');
    const submitBtn = document.getElementById('submit-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoader = submitBtn.querySelector('.btn-loader');
    const ageInput = document.querySelector('input[name="age"]');
    const guardianSection = document.getElementById('guardian-section');
    const totalAmountEl = document.getElementById('total-amount');
    const registrationFeeEl = document.getElementById('registration-fee-amount');
    const courseFeeEl = document.getElementById('course-fee-amount');
    const cohortSelect = document.querySelector('select[name="cohort"]');
    const dimensionInput = document.querySelector('input[name="dimension"]');
    const enrollmentTypeInput = document.querySelector('input[name="enrollment_type"]');
    const phoneInput = document.querySelector('input[name="phone"]');
    const guardianPhoneInput = document.querySelector('input[name="guardian_phone"]');
    const countryInput = document.querySelector('select[name="country"]');
    const emailInput = document.querySelector('input[name="email"]');
    const emailAlreadyLink = document.getElementById('email-already-registered-link');
    
    // Check if email is already registered (on blur) — show "Complete your payment" link
    if (emailInput && emailAlreadyLink) {
      let checkEmailTimeout = null;
      function checkEmailExists() {
        const email = (emailInput.value || '').trim();
        if (!email) {
          emailAlreadyLink.style.display = 'none';
          return;
        }
        fetch('{% url "check_email" %}?email=' + encodeURIComponent(email))
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.exists && data.redirect_url) {
              emailAlreadyLink.href = data.redirect_url;
              emailAlreadyLink.style.display = 'block';
            } else {
              emailAlreadyLink.style.display = 'none';
            }
          })
          .catch(function() { emailAlreadyLink.style.display = 'none'; });
      }
      emailInput.addEventListener('blur', function() {
        if (checkEmailTimeout) clearTimeout(checkEmailTimeout);
        checkEmailTimeout = setTimeout(checkEmailExists, 300);
      });
      emailInput.addEventListener('input', function() {
        if ((emailInput.value || '').trim() === '') emailAlreadyLink.style.display = 'none';
      });
      // On click: go to payment page (no form needed). Use JS redirect so it works even if href wasn't set.
      emailAlreadyLink.addEventListener('click', function(e) {
        e.preventDefault();
        var url = emailAlreadyLink.href;
        if (url && url !== '#' && url.indexOf('#') !== 0) {
          window.location.href = url;
          return;
        }
        var email = (emailInput.value || '').trim();
        if (!email) return;
        emailAlreadyLink.style.pointerEvents = 'none';
        emailAlreadyLink.textContent = 'Redirecting...';
        fetch('{% url "check_email" %}?email=' + encodeURIComponent(email))
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.redirect_url) {
              window.location.href = data.redirect_url;
            } else {
              emailAlreadyLink.style.pointerEvents = '';
              emailAlreadyLink.innerHTML = '<iconify-icon icon="lucide:info" style="vertical-align: middle; margin-right: 6px; color: #0071e3;"></iconify-icon>This email is already registered. <span style="color: #0071e3; font-weight: 600;">Complete your payment →</span>';
            }
          })
          .catch(function() {
            emailAlreadyLink.style.pointerEvents = '';
            emailAlreadyLink.innerHTML = '<iconify-icon icon="lucide:info" style="vertical-align: middle; margin-right: 6px; color: #0071e3;"></iconify-icon>This email is already registered. <span style="color: #0071e3; font-weight: 600;">Complete your payment →</span>';
          });
      });
    }
    
    // Dimension mapping: code -> ID
    const dimensionMap = {
      {% for dim in dimensions %}
      '{{ dim.code }}': '{{ dim.id }}',
      {% endfor %}
    };
    
    // Cohort mapping: ID -> code
    const cohortMap = {
      {% for cohort in cohorts %}
      '{{ cohort.id }}': '{{ cohort.code }}',
      {% endfor %}
    };
    let phoneInstance = null;
    let guardianPhoneInstance = null;
    
    // Initialize intl-tel-input for student phone
    if (phoneInput && window.intlTelInput) {
      phoneInstance = window.intlTelInput(phoneInput, {
        initialCountry: 'gh',
        separateDialCode: true,
        preferredCountries: ['gh', 'ng', 'us', 'gb', 'ca'],
        utilsScript: 'https://cdn.jsdelivr.net/npm/intl-tel-input@18.3.3/build/js/utils.js'
      });

      // Sync country dropdown with phone country selection
      if (countryInput && phoneInstance) {
        phoneInput.addEventListener('countrychange', function() {
          const countryData = phoneInstance.getSelectedCountryData();
          if (countryData?.name && countryInput) {
            // Try to find matching option in select dropdown
            const countryName = countryData.name;
            const options = countryInput.querySelectorAll ? countryInput.querySelectorAll('option') : countryInput.options;
            if (options) {
              for (let option of options) {
                if (option.textContent === countryName || option.value === countryName) {
                  countryInput.value = option.value;
                  break;
                }
              }
            }
          }
        });
        
        // Set initial country if phone has a country selected
        const selectedCountry = phoneInstance.getSelectedCountryData();
        if (selectedCountry?.name && countryInput && !countryInput.value) {
          const countryName = selectedCountry.name;
          const options = countryInput.querySelectorAll ? countryInput.querySelectorAll('option') : countryInput.options;
          if (options) {
            for (let option of options) {
              if (option.textContent === countryName || option.value === countryName) {
                countryInput.value = option.value;
                break;
              }
            }
          }
        }
      }
    }
    
    // Initialize intl-tel-input for guardian phone
    if (guardianPhoneInput && window.intlTelInput) {
      guardianPhoneInstance = window.intlTelInput(guardianPhoneInput, {
        initialCountry: 'gh',
        separateDialCode: true,
        preferredCountries: ['gh', 'ng', 'us', 'gb', 'ca'],
        utilsScript: 'https://cdn.jsdelivr.net/npm/intl-tel-input@18.3.3/build/js/utils.js'
      });
    }
    
    // Pricing data from template (USD)
    const pricing = {
      NEW: {
        total: {{ all_pricing.NEW.total|default:"150.00" }},
        registration_fee: {{ all_pricing.NEW.registration_fee|default:"50.00" }},
        course_fee: {{ all_pricing.NEW.course_fee|default:"100.00" }}
      },
      RETURNING: {
        total: {{ all_pricing.RETURNING.total|default:"120.00" }},
        registration_fee: {{ all_pricing.RETURNING.registration_fee|default:"20.00" }},
        course_fee: {{ all_pricing.RETURNING.course_fee|default:"100.00" }}
      }
    };
    
    // Pricing data in NGN
    const pricingNGN = {
      NEW: {
        total: {{ pricing_ngn.NEW.total|default:"225000" }},
        registration_fee: {{ pricing_ngn.NEW.registration_fee|default:"75000" }},
        course_fee: {{ pricing_ngn.NEW.course_fee|default:"150000" }}
      },
      RETURNING: {
        total: {{ pricing_ngn.RETURNING.total|default:"180000" }},
        registration_fee: {{ pricing_ngn.RETURNING.registration_fee|default:"30000" }},
        course_fee: {{ pricing_ngn.RETURNING.course_fee|default:"150000" }}
      }
    };
    
    // Exchange rate
    const exchangeRate = {{ exchange_rate|default:"1500.00" }};

    // Guardian fields are now always required for all registrations
    // Ensure required attributes are set
    if (guardianSection) {
      const guardianNameInput = document.querySelector('input[name="guardian_name"]');
      const guardianPhoneInput = document.querySelector('input[name="guardian_phone"]');
      if (guardianNameInput) {
        guardianNameInput.setAttribute('required', 'required');
      }
      if (guardianPhoneInput) {
        guardianPhoneInput.setAttribute('required', 'required');
      }
    }

    // Auto-suggest group based on age
    if (ageInput) {
      ageInput.addEventListener('input', function() {
        const age = parseInt(this.value);
        const groupSelect = document.querySelector('select[name="group"]');
        if (groupSelect && age >= 10 && age <= 22) {
          if (age <= 15) {
            groupSelect.value = 'G1';
          } else {
            groupSelect.value = 'G2';
          }
        }
      });
    }

    // Payment option toggle handler
    function updatePaymentDisplay() {
      const paymentOption = document.querySelector('input[name="payment_option"]:checked')?.value || 'partial';
      
      const amountDisplay = document.getElementById('amount-display');
      const ngnAmountDisplay = document.getElementById('ngn-amount');
      const paymentInfoText = document.getElementById('payment-info-text');
      const paymentAmountDisplay = document.getElementById('payment-amount-display');
      const partialLabel = document.getElementById('payment-option-partial-label');
      const fullLabel = document.getElementById('payment-option-full-label');
      
      // Get current pricing based on enrollment type
      const enrollmentType = enrollmentTypeInput?.value || 'NEW';
      const currentPricing = pricing[enrollmentType] || pricing.NEW;
      const currentPricingNGN = pricingNGN[enrollmentType] || pricingNGN.NEW;
      
      if (paymentOption === 'full') {
        // Full payment
        if (amountDisplay) {
          amountDisplay.textContent = Number(currentPricing.total).toFixed(2);
        }
        if (ngnAmountDisplay) {
          ngnAmountDisplay.textContent = Number(currentPricingNGN.total).toLocaleString('en-US');
        }
        if (paymentInfoText) {
          paymentInfoText.innerHTML = '<iconify-icon icon="lucide:check-circle-2" style="font-size: 14px; vertical-align: middle; color: #34c759;"></iconify-icon> Pay everything now and complete your enrollment immediately.';
        }
        if (paymentAmountDisplay) {
          paymentAmountDisplay.style.background = 'rgba(52, 199, 89, 0.08)';
          paymentAmountDisplay.style.borderColor = 'rgba(52, 199, 89, 0.2)';
        }
        if (fullLabel) {
          fullLabel.style.borderColor = '#34c759';
          fullLabel.style.background = 'rgba(52, 199, 89, 0.05)';
        }
        if (partialLabel) {
          partialLabel.style.borderColor = '#e5e7eb';
          partialLabel.style.background = 'white';
        }
        const totalAmountSpan = document.getElementById('total-amount');
        if (totalAmountSpan) {
          totalAmountSpan.style.color = '#34c759';
        }
      } else {
        // Partial payment (registration fee only)
        if (amountDisplay) {
          amountDisplay.textContent = Number(currentPricing.registration_fee).toFixed(2);
        }
        if (ngnAmountDisplay) {
          ngnAmountDisplay.textContent = Number(currentPricingNGN.registration_fee).toLocaleString('en-US');
        }
        if (paymentInfoText) {
          paymentInfoText.innerHTML = '<iconify-icon icon="lucide:info" style="font-size: 14px; vertical-align: middle;"></iconify-icon> You\'ll pay the course fee later to complete your enrollment.';
        }
        if (paymentAmountDisplay) {
          paymentAmountDisplay.style.background = 'rgba(255, 107, 53, 0.08)';
          paymentAmountDisplay.style.borderColor = 'rgba(255, 107, 53, 0.2)';
        }
        if (partialLabel) {
          partialLabel.style.borderColor = '#8b5cf6';
          partialLabel.style.background = 'rgba(139, 92, 246, 0.05)';
        }
        if (fullLabel) {
          fullLabel.style.borderColor = '#e5e7eb';
          fullLabel.style.background = 'white';
        }
        const totalAmountSpan = document.getElementById('total-amount');
        if (totalAmountSpan) {
          totalAmountSpan.style.color = '#ff6b35';
        }
      }
    }
    
    // Update payment display when enrollment type changes
    function updatePricingDisplay(pricingData) {
      if (!pricingData) {
        return;
      }
      
      // Get enrollment type for NGN pricing
      const enrollmentType = enrollmentTypeInput?.value || 'NEW';
      const currentPricingNGN = pricingNGN[enrollmentType] || pricingNGN.NEW;
      
      if (registrationFeeEl) {
        registrationFeeEl.textContent = '$' + Number(pricingData.registration_fee).toFixed(2);
      }
      if (courseFeeEl) {
        courseFeeEl.textContent = '$' + Number(pricingData.course_fee).toFixed(2);
      }
      
      // Update NGN amounts
      const registrationFeeNGN = document.getElementById('registration-fee-ngn');
      const courseFeeNGN = document.getElementById('course-fee-ngn');
      const totalFeeNGN = document.getElementById('total-fee-ngn');
      
      if (registrationFeeNGN) {
        registrationFeeNGN.textContent = Number(currentPricingNGN.registration_fee).toLocaleString('en-US');
      }
      if (courseFeeNGN) {
        courseFeeNGN.textContent = Number(currentPricingNGN.course_fee).toLocaleString('en-US');
      }
      if (totalFeeNGN) {
        totalFeeNGN.textContent = Number(currentPricingNGN.total).toLocaleString('en-US');
      }
      
      // Update payment option displays
      const partialRegFee = document.getElementById('partial-reg-fee');
      const partialRegFeeNGN = document.getElementById('partial-reg-fee-ngn');
      const fullTotalFee = document.getElementById('full-total-fee');
      const fullTotalFeeNGN = document.getElementById('full-total-fee-ngn');
      
      if (partialRegFee) {
        partialRegFee.textContent = Number(pricingData.registration_fee).toFixed(2);
      }
      if (partialRegFeeNGN) {
        partialRegFeeNGN.textContent = Number(currentPricingNGN.registration_fee).toLocaleString('en-US');
      }
      if (fullTotalFee) {
        fullTotalFee.textContent = Number(pricingData.total).toFixed(2);
      }
      if (fullTotalFeeNGN) {
        fullTotalFeeNGN.textContent = Number(currentPricingNGN.total).toLocaleString('en-US');
      }
      
      // Refresh payment display
      updatePaymentDisplay();
    }

    function getCohortKey() {
      if (!cohortSelect || !cohortSelect.value) {
        return null;
      }
      
      // Get cohort code from mapping using the selected cohort ID
      const cohortId = cohortSelect.value;
      const cohortCode = cohortMap[cohortId];
      
      if (cohortCode) {
        return cohortCode.toUpperCase();
      }
      
      // Fallback: check option text
      const selectedOption = cohortSelect.options[cohortSelect.selectedIndex];
      if (selectedOption) {
        const selectedText = (selectedOption.textContent || '').toLowerCase();
        if (selectedText.includes('cohort 1') || selectedText.includes('c1')) {
          return 'C1';
        }
        if (selectedText.includes('cohort 2') || selectedText.includes('c2')) {
          return 'C2';
        }
      }
      
      return null;
    }

    function setEnrollmentType(type) {
      if (enrollmentTypeInput) {
        enrollmentTypeInput.value = type;
      }
    }

    function setDimensionByCode(code) {
      if (!code || !dimensionInput) {
        return;
      }
      const dimensionId = dimensionMap[code];
      if (dimensionId) {
        dimensionInput.value = dimensionId;
      }
    }

    // Auto-assign dimension/enrollment and pricing based on cohort selection
    function applyCohortSelectionDefaults() {
      const cohortKey = getCohortKey();
      if (!cohortKey) {
        return false;
      }

      if (cohortKey === 'C1') {
        setDimensionByCode('S');
        setEnrollmentType('RETURNING');
        updatePricingDisplay(pricing.RETURNING);
        return true;
      }

      if (cohortKey === 'C2') {
        setDimensionByCode('A');
        setEnrollmentType('NEW');
        updatePricingDisplay(pricing.NEW);
        return true;
      }

      return false;
    }

    if (cohortSelect) {
      cohortSelect.addEventListener('change', function() {
        applyCohortSelectionDefaults();
        updatePaymentDisplay(); // Update payment display when cohort changes
      });
      applyCohortSelectionDefaults();
    }
    
    // Initialize payment display on page load
    updatePaymentDisplay();
    
    // Add event listeners to radio buttons
    document.querySelectorAll('input[name="payment_option"]').forEach(radio => {
      radio.addEventListener('change', updatePaymentDisplay);
    });

    // Handle form submission
    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Ensure dimension and enrollment_type are set before submission
        const cohortKey = getCohortKey();
        if (cohortKey) {
          applyCohortSelectionDefaults();
        }
        
        // Validate required fields are set
        if (!dimensionInput || !dimensionInput.value) {
          alert('Please select a cohort. Dimension will be auto-assigned.');
          return;
        }
        if (!enrollmentTypeInput || !enrollmentTypeInput.value) {
          alert('Please select a cohort. Enrollment type will be auto-assigned.');
          return;
        }
        
        submitBtn.disabled = true;
        btnText.style.display = 'none';
        btnLoader.style.display = 'flex';
        submitBtn.style.cursor = 'not-allowed';

        const formData = new FormData(form);
        
        // Add payment option to form data
        const paymentOption = document.querySelector('input[name="payment_option"]:checked')?.value || 'partial';
        formData.set('payment_option', paymentOption);
        const paymentGateway = document.querySelector('input[name="payment_gateway"]:checked')?.value || 'squad';
        formData.set('payment_gateway', paymentGateway);
        
        if (phoneInstance && phoneInput) {
          const internationalNumber = phoneInstance.getNumber();
          if (internationalNumber) {
            phoneInput.value = internationalNumber;
            formData.set('phone', internationalNumber);
          }
        }
        if (guardianPhoneInstance && guardianPhoneInput) {
          const guardianInternationalNumber = guardianPhoneInstance.getNumber();
          if (guardianInternationalNumber) {
            guardianPhoneInput.value = guardianInternationalNumber;
            formData.set('guardian_phone', guardianInternationalNumber);
          }
        }
        
        try {
          const response = await fetch('{% url "initialize_payment" %}', {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
          });

          const data = await response.json();

          if (data.status === 'success' && data.authorization_url) {
            // Smooth redirect
            window.location.href = data.authorization_url;
          } else if (data.status === 'already_registered' && data.redirect_url) {
            // Email already registered — send them to the payment page
            window.location.href = data.redirect_url;
          } else {
            // Show detailed error messages
            let errorMessage = data.message || 'Failed to initialize payment';
            
            if (data.errors) {
              const errorList = Object.entries(data.errors).map(([field, errors]) => {
                const fieldName = field.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                return `${fieldName}: ${Array.isArray(errors) ? errors.join(', ') : errors}`;
              }).join('\n');
              
              if (errorList) {
                errorMessage = 'Please fix the following errors:\n\n' + errorList;
              }
            }
            
            alert(errorMessage);
            submitBtn.disabled = false;
            btnText.style.display = 'flex';
            btnLoader.style.display = 'none';
            submitBtn.style.cursor = 'pointer';
          }
        } catch (error) {
          console.error('Error:', error);
          alert('An error occurred. Please try again.');
          submitBtn.disabled = false;
          btnText.style.display = 'inline';
          btnLoader.style.display = 'none';
          submitBtn.style.cursor = 'pointer';
        }
      });
    }
  });
</script>
{% endblock %}
