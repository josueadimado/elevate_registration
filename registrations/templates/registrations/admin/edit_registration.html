{% extends 'registrations/admin/base.html' %}
{% load static %}

{% block page_title %}{{ page_title|default:'Edit Registration' }}{% endblock %}

{% block content %}
<div class="fade-in-up">
  <div class="edit-form-container">
    <div class="edit-form-header">
      <div>
        <h2 style="font-size: 28px; font-weight: 600; letter-spacing: -0.02em; margin-bottom: 8px; color: hsl(var(--admin-foreground));">
          {{ page_title|default:'Edit Registration' }}
        </h2>
        {% if registration %}
        <p style="color: hsl(var(--admin-muted-foreground)); font-size: 15px;">
          Registration ID: {{ registration.id|truncatechars:20 }}
        </p>
        {% endif %}
      </div>
      <a href="{% url 'admin_registrations' %}" class="btn btn-secondary">
        <iconify-icon icon="lucide:arrow-left"></iconify-icon>
        Back to Registrations
      </a>
    </div>

    <!-- Participant ID – auto-generated on Save if cohort+dimension set; or use buttons -->
    {% if registration %}
    <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0071e3; border-radius: 16px; padding: 20px; margin-bottom: 24px;">
      <h3 style="font-size: 16px; font-weight: 700; color: #1d1d1f; margin: 0 0 10px 0;">
        <iconify-icon icon="lucide:id-card" style="vertical-align: middle; color: #0071e3;"></iconify-icon>
        Participant ID
      </h3>
      {% if registration.participant_id %}
        <p style="margin: 0 0 12px 0; font-family: monospace; font-weight: 700; font-size: 18px; color: #0071e3;">{{ registration.participant_id }}</p>
        <form method="post" action="{% url 'send_participant_id_email' registration.id %}" style="display: inline-block;">
          {% csrf_token %}
          <button type="submit" class="btn btn-secondary btn-sm">Send ID by email</button>
        </form>
      {% else %}
        <p style="margin: 0 0 12px 0; color: #64748b;">Not assigned. <strong>Save this form</strong> (with Cohort and Dimension set) to generate it automatically, or use the buttons below.</p>
        {% if registration.cohort and registration.dimension %}
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <form method="post" action="{% url 'generate_participant_id' registration.id %}" style="display: inline-block;">
              {% csrf_token %}
              <button type="submit" class="btn btn-primary btn-sm">Generate ID</button>
            </form>
            <form method="post" action="{% url 'send_participant_id_email' registration.id %}" style="display: inline-block;">
              {% csrf_token %}
              <button type="submit" class="btn btn-secondary btn-sm">Generate &amp; send by email</button>
            </form>
          </div>
        {% else %}
          <p style="margin: 0; color: #64748b; font-size: 14px;">Set <strong>Cohort</strong> and <strong>Dimension</strong> above, then click Save — the ID will be created automatically.</p>
        {% endif %}
      {% endif %}
    </div>
    {% endif %}

    <form method="post" class="admin-edit-form">
      {% csrf_token %}
      
      <!-- Student Information -->
      <fieldset class="form-fieldset">
        <legend>Student Information</legend>
        <div class="form-grid">
          <div class="form-group">
            <label for="{{ form.full_name.id_for_label }}">{{ form.full_name.label }}</label>
            {{ form.full_name }}
            {% if form.full_name.errors %}
              <div class="form-error">{{ form.full_name.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
            {{ form.email }}
            {% if form.email.errors %}
              <div class="form-error">{{ form.email.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label for="{{ form.phone.id_for_label }}">{{ form.phone.label }}</label>
            {{ form.phone }}
            {% if form.phone.errors %}
              <div class="form-error">{{ form.phone.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label for="{{ form.country.id_for_label }}">{{ form.country.label }}</label>
            {{ form.country }}
            {% if form.country.errors %}
              <div class="form-error">{{ form.country.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label for="{{ form.age.id_for_label }}">{{ form.age.label }}</label>
            {{ form.age }}
            {% if form.age.errors %}
              <div class="form-error">{{ form.age.errors }}</div>
            {% endif %}
          </div>
        </div>
      </fieldset>

      <!-- Program Selection -->
      <fieldset class="form-fieldset">
        <legend>Program Selection</legend>
        <div class="form-grid">
          <div class="form-group">
            <label for="{{ form.group.id_for_label }}">{{ form.group.label }}</label>
            {{ form.group }}
            {% if form.group.errors %}
              <div class="form-error">{{ form.group.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label for="{{ form.cohort.id_for_label }}">{{ form.cohort.label }}</label>
            {{ form.cohort }}
            {% if form.cohort.errors %}
              <div class="form-error">{{ form.cohort.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label for="{{ form.dimension.id_for_label }}">{{ form.dimension.label }}</label>
            {{ form.dimension }}
            {% if form.dimension.errors %}
              <div class="form-error">{{ form.dimension.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label for="{{ form.enrollment_type.id_for_label }}">{{ form.enrollment_type.label }}</label>
            {{ form.enrollment_type }}
            {% if form.enrollment_type.errors %}
              <div class="form-error">{{ form.enrollment_type.errors }}</div>
            {% endif %}
          </div>
        </div>
      </fieldset>

      <!-- Guardian Information -->
      <fieldset class="form-fieldset">
        <legend>Guardian Information</legend>
        <div class="form-grid">
          <div class="form-group">
            <label for="{{ form.guardian_name.id_for_label }}">{{ form.guardian_name.label }}</label>
            {{ form.guardian_name }}
            {% if form.guardian_name.errors %}
              <div class="form-error">{{ form.guardian_name.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label for="{{ form.guardian_phone.id_for_label }}">{{ form.guardian_phone.label }}</label>
            {{ form.guardian_phone }}
            {% if form.guardian_phone.errors %}
              <div class="form-error">{{ form.guardian_phone.errors }}</div>
            {% endif %}
          </div>
        </div>
      </fieldset>

      <!-- Payment Information -->
      <fieldset class="form-fieldset">
        <legend>Payment Information</legend>
        <div class="form-grid">
          <div class="form-group">
            <label for="{{ form.currency.id_for_label }}">{{ form.currency.label }}</label>
            {{ form.currency }}
            {% if form.currency.errors %}
              <div class="form-error">{{ form.currency.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label for="{{ form.amount.id_for_label }}">{{ form.amount.label }}</label>
            <div style="position: relative; display: flex; align-items: center;">
              <span id="currency-symbol" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #86868b; font-weight: 500; pointer-events: none; z-index: 1;">
                {% if registration %}
                  {% if registration.currency == 'NGN' %}₦{% else %}${% endif %}
                {% else %}
                  $
                {% endif %}
              </span>
              <div style="flex: 1;">
                {{ form.amount }}
              </div>
            </div>
            {% if form.amount.errors %}
              <div class="form-error">{{ form.amount.errors }}</div>
            {% endif %}
            <script>
              // Update currency symbol when currency changes
              document.addEventListener('DOMContentLoaded', function() {
                const currencyField = document.getElementById('{{ form.currency.id_for_label }}');
                const currencySymbol = document.getElementById('currency-symbol');
                const amountField = document.getElementById('{{ form.amount.id_for_label }}');
                
                if (currencyField && currencySymbol && amountField) {
                  // Adjust amount field padding to make room for symbol
                  amountField.style.paddingLeft = '32px';
                  
                  currencyField.addEventListener('change', function() {
                    if (this.value === 'NGN') {
                      currencySymbol.textContent = '₦';
                    } else {
                      currencySymbol.textContent = '$';
                    }
                  });
                }
              });
            </script>
          </div>
          
          <div class="form-group">
            <label for="{{ form.status.id_for_label }}">{{ form.status.label }}</label>
            {{ form.status }}
            {% if form.status.errors %}
              <div class="form-error">{{ form.status.errors }}</div>
            {% endif %}
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <p style="font-size: 13px; color: #64748b; margin-bottom: 12px;">For <strong>offline payments</strong>, check the boxes below to mark as full or half paid.</p>
          </div>
          <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
            <label for="{{ form.registration_fee_paid.id_for_label }}" style="margin: 0; font-weight: 600;">{{ form.registration_fee_paid.label }}</label>
            {{ form.registration_fee_paid }}
            {% if form.registration_fee_paid.errors %}
              <div class="form-error">{{ form.registration_fee_paid.errors }}</div>
            {% endif %}
          </div>
          <div class="form-group">
            <label for="{{ form.registration_fee_amount.id_for_label }}">{{ form.registration_fee_amount.label }} (optional)</label>
            {{ form.registration_fee_amount }}
            {% if form.registration_fee_amount.errors %}
              <div class="form-error">{{ form.registration_fee_amount.errors }}</div>
            {% endif %}
          </div>
          <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
            <label for="{{ form.course_fee_paid.id_for_label }}" style="margin: 0; font-weight: 600;">{{ form.course_fee_paid.label }}</label>
            {{ form.course_fee_paid }}
            {% if form.course_fee_paid.errors %}
              <div class="form-error">{{ form.course_fee_paid.errors }}</div>
            {% endif %}
          </div>
          <div class="form-group">
            <label for="{{ form.course_fee_amount.id_for_label }}">{{ form.course_fee_amount.label }} (optional)</label>
            {{ form.course_fee_amount }}
            {% if form.course_fee_amount.errors %}
              <div class="form-error">{{ form.course_fee_amount.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label for="{{ form.squad_reference.id_for_label }}">{{ form.squad_reference.label }}</label>
            {{ form.squad_reference }}
            {% if form.squad_reference.errors %}
              <div class="form-error">{{ form.squad_reference.errors }}</div>
            {% endif %}
          </div>
        </div>
      </fieldset>

      <!-- Additional Information -->
      <fieldset class="form-fieldset">
        <legend>Additional Information</legend>
        <div class="form-grid">
          <div class="form-group">
            <label for="{{ form.referral_source.id_for_label }}">{{ form.referral_source.label }}</label>
            {{ form.referral_source }}
            {% if form.referral_source.errors %}
              <div class="form-error">{{ form.referral_source.errors }}</div>
            {% endif %}
          </div>
        </div>
      </fieldset>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          <iconify-icon icon="lucide:save"></iconify-icon>
          Save Changes
        </button>
        <a href="{% url 'admin_registrations' %}" class="btn btn-secondary">
          Cancel
        </a>
        {% if registration %}
        <form method="post" action="{% url 'delete_registration' registration.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this registration? This action cannot be undone.');">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
            <iconify-icon icon="lucide:trash-2"></iconify-icon>
            Delete
          </button>
        </form>
        {% endif %}
      </div>
    </form>
  </div>
</div>
{% endblock %}
