{% extends 'registrations/admin/base.html' %}
{% load static %}

{% block page_title %}Registrations{% endblock %}

{% block content %}
<div class="fade-in-up">
  <!-- Payment summary: X pending, X half paid, X full paid -->
  <div class="payment-summary-bar">
    <span class="summary-item summary-pending"><strong>{{ count_pending }}</strong> pending payment</span>
    <span class="summary-item summary-half"><strong>{{ count_half_paid }}</strong> half payment</span>
    <span class="summary-item summary-full"><strong>{{ count_full_paid }}</strong> full payment</span>
    {% if count_failed %}<span class="summary-item summary-failed"><strong>{{ count_failed }}</strong> failed</span>{% endif %}
  </div>
  <!-- Filters -->
  <form method="get" class="filter-bar">
    <input 
      type="text" 
      class="filter-input" 
      placeholder="Search by name, email, phone..."
      value="{{ search_query }}"
      name="search"
    >
    <select name="status" class="filter-select" onchange="this.form.submit()">
      <option value="">All Status</option>
      <option value="PAID" {% if status_filter == 'PAID' %}selected{% endif %}>Full paid</option>
      <option value="HALF" {% if status_filter == 'HALF' %}selected{% endif %}>Half paid</option>
      <option value="PENDING" {% if status_filter == 'PENDING' %}selected{% endif %}>Pending</option>
      <option value="FAILED" {% if status_filter == 'FAILED' %}selected{% endif %}>Failed</option>
    </select>
    <select name="cohort" class="filter-select" onchange="this.form.submit()">
      <option value="">All Cohorts</option>
      {% for cohort in cohorts %}
      <option value="{{ cohort.id }}" {% if cohort_filter == cohort.id|stringformat:"s" %}selected{% endif %}>
        {{ cohort.name }}
      </option>
      {% endfor %}
    </select>
    <select name="dimension" class="filter-select" onchange="this.form.submit()">
      <option value="">All Dimensions</option>
      {% for dimension in dimensions %}
      <option value="{{ dimension.id }}" {% if dimension_filter == dimension.id|stringformat:"s" %}selected{% endif %}>
        {{ dimension.code }}: {{ dimension.name }}
      </option>
      {% endfor %}
    </select>
    <button type="submit" class="btn btn-primary">Apply Filters</button>
    <a href="{% url 'admin_registrations' %}" class="btn btn-secondary">Clear</a>
  </form>

  <!-- Registrations Table -->
  <div class="data-table">
    <div class="table-header">
      <h2 class="table-title">All Registrations ({{ page_obj.paginator.count }})</h2>
      <div class="table-header-actions">
        <form method="post" action="{% url 'bulk_generate_participant_ids' %}" style="display: inline-block;" onsubmit="return confirm('Generate participant IDs for everyone who has Cohort and Dimension but no ID yet?');">
          {% csrf_token %}
          <button type="submit" class="btn btn-secondary btn-sm" title="Generate IDs for existing registrations that don't have one yet">
            <iconify-icon icon="lucide:hash"></iconify-icon>
            Generate missing IDs
          </button>
        </form>
        <a href="{% url 'download_registrations_template' %}" class="btn btn-secondary btn-sm" title="Download template to fill and import registrations">
          <iconify-icon icon="lucide:file-down"></iconify-icon>
          Template
        </a>
        <a href="{% url 'admin_import_registrations' %}" class="btn btn-secondary btn-sm" title="Upload CSV to register participants manually">
          <iconify-icon icon="lucide:upload"></iconify-icon>
          Import CSV
        </a>
        <a href="{% url 'admin_update_participant_ids_from_file' %}" class="btn btn-secondary btn-sm" title="Apply participant IDs from an official list (CSV or Excel)">
          <iconify-icon icon="lucide:file-input"></iconify-icon>
          Update IDs from file
        </a>
        <a href="{% url 'export_registrations' %}?{{ request.GET.urlencode }}" class="btn btn-secondary btn-sm" title="Export current list as CSV">
          <iconify-icon icon="lucide:download"></iconify-icon>
          Export CSV
        </a>
        <a href="{% url 'add_registration' %}" class="btn btn-primary btn-sm">
          <iconify-icon icon="lucide:plus"></iconify-icon>
          Add New
        </a>
      </div>
    </div>
    <div class="table-content">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Cohort</th>
            <th>Dimension</th>
            <th>Participant ID</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for registration in registrations %}
          <tr>
            <td data-label="Name" style="font-weight: 600;">{{ registration.full_name }}</td>
            <td data-label="Email">{{ registration.email }}</td>
            <td data-label="Cohort">
              {% if registration.cohort %}
                <span class="badge badge-info">{{ registration.cohort.name }}</span>
              {% else %}
                -
              {% endif %}
            </td>
            <td data-label="Dimension">
              {% if registration.dimension %}
                <span class="badge badge-info">{{ registration.dimension.code }}</span>
              {% else %}
                -
              {% endif %}
            </td>
            <td data-label="Participant ID">
              {% if registration.participant_id %}
                <span style="font-family: monospace; font-size: 13px; color: #0071e3;">{{ registration.participant_id }}</span>
              {% else %}
                <span style="color: #86868b;">—</span>
              {% endif %}
            </td>
            <td data-label="Amount" style="font-weight: 600; color: #0071e3;">
              {% if registration.currency == 'NGN' %}
                ₦{{ registration.amount|floatformat:0 }}
              {% else %}
                ${{ registration.amount|floatformat:0 }}
              {% endif %}
            </td>
            <td data-label="Status">
              {% if registration.status == 'FAILED' %}
                <span class="badge badge-danger">Failed</span>
              {% elif registration.registration_fee_paid and registration.course_fee_paid %}
                <span class="badge badge-success" style="background:#dcfce7;color:#166534;border:1px solid rgba(22,101,52,0.25);">Full paid</span>
              {% elif registration.registration_fee_paid %}
                <span class="badge badge-warning" title="Registration fee paid; course fee pending">Half paid (reg)</span>
              {% elif registration.course_fee_paid %}
                <span class="badge badge-warning" title="Course fee paid; registration fee pending">Half paid (course)</span>
              {% else %}
                <span class="badge badge-pending">Pending</span>
              {% endif %}
            </td>
            <td data-label="Date">{{ registration.created_at|date:"M d, Y" }}</td>
            <td>
              <div class="action-buttons">
                <a href="{% url 'view_registration' registration.id %}" class="action-btn action-btn-view" title="View Details">
                  <iconify-icon icon="lucide:eye"></iconify-icon>
                </a>
                <a href="{% url 'edit_registration' registration.id %}" class="action-btn action-btn-edit" title="Edit">
                  <iconify-icon icon="lucide:edit"></iconify-icon>
                </a>
                <form method="post" action="{% url 'delete_registration' registration.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this registration?');">
                  {% csrf_token %}
                  <button type="submit" class="action-btn action-btn-delete" title="Delete">
                    <iconify-icon icon="lucide:trash-2"></iconify-icon>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" style="text-align: center; padding: 60px; color: #86868b;">
              <iconify-icon icon="lucide:inbox" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></iconify-icon>
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">No registrations found</div>
              <div>Try adjusting your filters</div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if page_obj.paginator.num_pages > 1 %}
    <div class="table-pagination">
      <span class="pagination-info">
        Showing {{ page_obj.start_index }}–{{ page_obj.end_index }} of {{ page_obj.paginator.count }}
      </span>
      <nav class="pagination-nav" aria-label="Registrations pagination">
        {% if page_obj.has_previous %}
          <a href="?{% if query_string %}{{ query_string }}&{% endif %}page=1" class="btn btn-secondary btn-sm">First</a>
          <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.previous_page_number }}" class="btn btn-secondary btn-sm">Previous</a>
        {% endif %}
        <span class="pagination-current">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
          <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.next_page_number }}" class="btn btn-secondary btn-sm">Next</a>
          <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.paginator.num_pages }}" class="btn btn-secondary btn-sm">Last</a>
        {% endif %}
      </nav>
    </div>
    {% endif %}
  </div>
</div>

<style>
  .table-pagination {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 16px 24px;
    border-top: 1px solid #d2d2d7;
    background: #f5f5f7;
  }
  .pagination-info {
    font-size: 14px;
    color: #64748b;
  }
  .pagination-nav {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .pagination-current {
    font-size: 14px;
    font-weight: 600;
    color: #1d1d1f;
  }
  .payment-summary-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: center;
    margin-bottom: 20px;
    padding: 14px 20px;
    background: #fff;
    border: 1px solid #d2d2d7;
    border-radius: 12px;
    font-size: 14px;
    color: #1d1d1f;
  }
  .payment-summary-bar .summary-item { white-space: nowrap; }
  .payment-summary-bar .summary-item strong { margin-right: 2px; }
  .summary-pending { color: #64748b; }
  .summary-half { color: #ff6b35; }
  .summary-full { color: #34c759; }
  .summary-failed { color: #ef4444; }
  .badge-pending {
    background: #f1f5f9;
    color: #64748b;
    border: 1px solid #e2e8f0;
    font-weight: 600;
  }
  .action-btn-view {
    background: #0071e3;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    text-decoration: none;
  }
  .action-btn-view:hover {
    background: #0077ed;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 113, 227, 0.2);
  }
  .action-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
  }
</style>
{% endblock %}
