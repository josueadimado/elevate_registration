{% extends 'registrations/admin/base.html' %}
{% load static %}

{% block page_title %}{{ page_title|default:'Edit Pricing' }}{% endblock %}

{% block content %}
<div class="fade-in-up">
  <div class="edit-form-container">
    <div class="edit-form-header">
      <div>
        <h2 style="font-size: 28px; font-weight: 600; letter-spacing: -0.02em; margin-bottom: 8px; color: hsl(var(--admin-foreground));">
          {{ page_title|default:'Edit Pricing' }}
        </h2>
        {% if pricing %}
        <p style="color: hsl(var(--admin-muted-foreground)); font-size: 15px;">
          Type: {{ pricing.get_enrollment_type_display }}
        </p>
        {% endif %}
      </div>
      <a href="{% url 'admin_settings' %}" class="btn btn-secondary">
        <iconify-icon icon="lucide:arrow-left"></iconify-icon>
        Back to Settings
      </a>
    </div>

    <form method="post" class="admin-edit-form">
      {% csrf_token %}
      
      <fieldset class="form-fieldset">
        <legend>Pricing Information</legend>
        <div class="form-grid">
          <div class="form-group">
            <label for="{{ form.enrollment_type.id_for_label }}">{{ form.enrollment_type.label }}</label>
            {{ form.enrollment_type }}
            {% if form.enrollment_type.errors %}
              <div class="form-error">{{ form.enrollment_type.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label for="{{ form.currency.id_for_label }}">{{ form.currency.label }}</label>
            <div style="position: relative; display: block;">
              {{ form.currency }}
            </div>
            {% if form.currency.errors %}
              <div class="form-error">{{ form.currency.errors }}</div>
            {% endif %}
            <small style="display: block; margin-top: 6px; color: #86868b; font-size: 13px;">
              Select the currency for this pricing configuration (USD or NGN)
            </small>
          </div>
          
          <div class="form-group">
            <label for="{{ form.registration_fee.id_for_label }}">{{ form.registration_fee.label }}</label>
            <div style="position: relative; display: flex; align-items: center;">
              <span id="currency-symbol-registration" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #86868b; font-weight: 500; pointer-events: none; z-index: 1;">
                {% if pricing %}
                  {% if pricing.currency == 'NGN' %}₦{% else %}${% endif %}
                {% else %}
                  $
                {% endif %}
              </span>
              <div style="flex: 1;">
                {{ form.registration_fee }}
              </div>
            </div>
            {% if form.registration_fee.errors %}
              <div class="form-error">{{ form.registration_fee.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label for="{{ form.course_fee.id_for_label }}">{{ form.course_fee.label }}</label>
            <div style="position: relative; display: flex; align-items: center;">
              <span id="currency-symbol-course" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #86868b; font-weight: 500; pointer-events: none; z-index: 1;">
                {% if pricing %}
                  {% if pricing.currency == 'NGN' %}₦{% else %}${% endif %}
                {% else %}
                  $
                {% endif %}
              </span>
              <div style="flex: 1;">
                {{ form.course_fee }}
              </div>
            </div>
            {% if form.course_fee.errors %}
              <div class="form-error">{{ form.course_fee.errors }}</div>
            {% endif %}
          </div>
          
          {% if pricing %}
          <div class="form-group" style="grid-column: 1 / -1;">
            <div style="background: hsl(var(--admin-muted)); padding: 16px; border-radius: 12px; border: 1px solid hsl(var(--admin-border));">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600; color: hsl(var(--admin-foreground));">Total Amount:</span>
                <span id="total-amount-display" style="font-size: 24px; font-weight: 700; color: hsl(var(--admin-primary));">
                  {% if pricing.currency == 'NGN' %}₦{% else %}${% endif %}{{ pricing.total_amount|floatformat:2 }}
                </span>
              </div>
            </div>
          </div>
          {% endif %}
          
          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              {{ form.is_active }}
              <span>{{ form.is_active.label }}</span>
            </label>
            {% if form.is_active.errors %}
              <div class="form-error">{{ form.is_active.errors }}</div>
            {% endif %}
          </div>
        </div>
      </fieldset>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          <iconify-icon icon="lucide:save"></iconify-icon>
          Save Changes
        </button>
        <a href="{% url 'admin_settings' %}" class="btn btn-secondary">
          Cancel
        </a>
        {% if pricing %}
        <form method="post" action="{% url 'delete_pricing' pricing.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this pricing configuration? This action cannot be undone.');">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
            <iconify-icon icon="lucide:trash-2"></iconify-icon>
            Delete
          </button>
        </form>
        {% endif %}
      </div>
    </form>
  </div>
</div>

<script>
  // Update currency symbols when currency changes
  document.addEventListener('DOMContentLoaded', function() {
    // Try multiple ways to find the currency field
    let currencyField = document.getElementById('{{ form.currency.id_for_label }}');
    if (!currencyField) {
      // Fallback: try to find by name attribute
      currencyField = document.querySelector('select[name="currency"]');
    }
    if (!currencyField) {
      // Another fallback: find by ID pattern
      currencyField = document.querySelector('select[id*="currency"]');
    }
    
    const currencySymbolRegistration = document.getElementById('currency-symbol-registration');
    const currencySymbolCourse = document.getElementById('currency-symbol-course');
    const registrationFeeField = document.getElementById('{{ form.registration_fee.id_for_label }}');
    const courseFeeField = document.getElementById('{{ form.course_fee.id_for_label }}');
    const totalAmountDisplay = document.getElementById('total-amount-display');
    
    // Function to update currency symbols
    function updateCurrencySymbols(currency) {
      if (!currency) return;
      
      const symbol = currency === 'NGN' ? '₦' : '$';
      if (currencySymbolRegistration) {
        currencySymbolRegistration.textContent = symbol;
      }
      if (currencySymbolCourse) {
        currencySymbolCourse.textContent = symbol;
      }
      
      // Update total amount display if it exists (only when editing existing pricing)
      {% if pricing %}
      if (totalAmountDisplay) {
        const totalAmount = parseFloat('{{ pricing.total_amount|floatformat:2 }}');
        if (!isNaN(totalAmount)) {
          totalAmountDisplay.textContent = symbol + totalAmount.toFixed(2);
        }
      }
      {% endif %}
    }
    
    // Set initial padding for inputs with currency symbols
    if (registrationFeeField) {
      registrationFeeField.style.paddingLeft = '32px';
    }
    if (courseFeeField) {
      courseFeeField.style.paddingLeft = '32px';
    }
    
    if (currencyField) {
      // Make sure the currency field is visible and styled
      currencyField.style.display = 'block';
      currencyField.style.visibility = 'visible';
      currencyField.style.opacity = '1';
      
      // Update on change
      currencyField.addEventListener('change', function() {
        updateCurrencySymbols(this.value);
      });
      
      // Set initial value if field has a value
      if (currencyField.value) {
        updateCurrencySymbols(currencyField.value);
      } else {
        // Default to USD if no value is set
        updateCurrencySymbols('USD');
      }
      
      // Also listen for input events (for programmatic changes)
      currencyField.addEventListener('input', function() {
        updateCurrencySymbols(this.value);
      });
    } else {
      console.warn('Currency field not found. Make sure the form field has the correct ID.');
      // Fallback: update symbols based on default
      updateCurrencySymbols('USD');
    }
  });
</script>
{% endblock %}
